<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="title-container">
        <h1>Rétroaction par IA</h1>
    </div>
    <div class="description">
        <p>
            Bienvenue ! Ce site propose un outil de génération par intelligence artificielle de
            rétroaction pour les projets de programmation des étudiants, destiné à assister les
            enseignants dans leur évaluation.
        </p>
        <p>Pour débuter, téléverser vos fichiers plus bas.</p>
        <span class="show-hide-info" id="show-more" onclick="toggleMore()"><u>En savoir plus</u></span>
        <div id="more-info">
            <div class="red-line"></div>
            <p>
                Cet outil a été conçu pour assister les enseignants dans leur évaluation. Il s'agit
                d'un système capable de générer des retours sur les projets de programmation réalisés
                par les étudiants.
            </p>
            <p>
                En utilisant la bibliothèque OpenAI, qui alimente notamment ChatGPT,
                un agent LLM (modèle de langage) analyse le code des étudiants en le comparant aux
                documents fournis par l'enseignant, tels que l'énoncé du projet, et produit un rapport
                détaillé. <b>Cet outil ne vise pas à remplacer la correction humaine</b>, mais plutôt à
                soutenir les étudiants en mettant en lumière des éléments spécifiques du code que les
                enseignants n'ont pas toujours le temps d'examiner. Il revient à l'utilisateur de ce
                système de communiquer les commentaires générés aux étudiants.
            </p>
            <p>
                Pour utiliser cet outil, vous aurez besoin de l'énoncé du projet
                <span class="tooltip">(?)
                    <span class="tooltip-text">L'énoncé est le document expliquant aux étudiants ce
                        qu'ils doivent réaliser dans le projet</span>
                </span>.
                Vous pouvez ajouter un document de normes de programmation
                <span class="tooltip">(?)
                    <span class="tooltip-text">Ce document est général au cours et contient des
                        guides de bonne pratique en programmation comme le nom des variables,
                        l'indentation, etc.</span>
                </span> pour de meilleurs résultats par l'IA.
                Vous devez télécharger un projet à la fois ; une fois le traitement d'un projet
                terminé, vous serez invité à télécharger le suivant. Vous pourrez ensuite naviguer
                facilement d'une rétroaction à l'autre. Il y a une limite de 50 fichiers que vous
                pouvez télécharger par projet.
            </p>
            <p>Le temps de traitement peut varier en fonction du volume de documents déposés.
                En général, pour un projet relativement simple comportant une dizaine de
                fichiers, le traitement prend environ une minute.
            </p>
            <p>
                Les extensions de fichiers acceptées sont .c, .cpp, .cs, .css, .doc, .docx, .go, .html,
                .java, .js, .json, .md, .pdf, .php, .pptx, .py, .rb, .sh, .tex, .ts et .txt.
            </p>
            <p class="show-hide-info" id="show-less" onclick="toggleMore()"><u>Masquer</u></p>
        </div>
    </div>
    <div class="red-line"></div>
    <button id="shortcut" onclick="sendFilesShortcut()">Upload shortcut</button>
    <form id="send-form" enctype="multipart/form-data">
        <div id="teacher-documents" class="upload-container">
            <div>
                <h3>Énoncé</h3>
                <label id="label-standards" for="file-standards" class="upload-box">Téléversez le fichier</label>
                <input id="file-standards" type="file" name="standards"
                    onchange="updateFileLabel(this, 'label-standards')">
            </div>
            <div>
                <h3>Normes de programmation</h3>
                <label id="label-criteria" for="file-criteria" class="upload-box">Téléversez le fichier (optionnel mais
                    recommandé)</label>
                <input id="file-criteria" type="file" name="criteria"
                    onchange="updateFileLabel(this, 'label-criteria')">
            </div>
            <button type="button" class="next-button" onclick="nextClick()">Suivant</button>
            <p class="error-message" id="err-first-box"></p>
        </div>
        <div id="student-documents" class="upload-container">
            <div id="label-project-1" class="std-project">
                <h3>Projet #1</h3>
                <div class="input-group">
                    <label for="file-project-1" class="upload-box std-doc">Téléversez les fichiers</label>
                    <input id="file-project-1" type="file" name="submissions" multiple onchange="updateFileLabel(this, 'label-project-1')">
                </div>
            </div>
            <button type="button" id="add-project" onclick="addProject()">+<span class="tooltip-text">Ajouter un autre projet</span></button>
            <div id="button-row">
                <button type="button" class="prev-button" onclick="prevClick()">Précédent</button>
                <button type="submit" class="next-button" onclick="nextClick()">Envoyer</button>
            </div>
            <p class="error-message" id="err-scd-box"></p>
        </div>
    </form>
    <div id="waiting-ctn">
        <p>1 de </p>
        <label id="waiting-text" for="waiting-bar">Traitement en cours...</label>
        <progress id="waiting-bar" value="0" max="100"></progress>
    </div>
    <table id="error-element" cellspacing="0">
        <tr id="error-title">
            <td>Une erreur est survenue</td>
            <td id="close-error-btn" onclick="closeErrorTable()">X</td>
        </tr>
        <tr id="system-error">
            <td id="sys-err-message"></td>
        </tr>
    </table>
</body>

<script>
    // Shortcut for uploading files : to delete later
    async function sendFilesShortcut() {
        alert("WIP");
        /*
        try {
            const standardsFile = await fetch('/enonce.docx');
            if (!standardsFile)
                throw new Error('Error fetching standards file');
            const standardsBlob = await standardsFile.blob();
            const initializeFormData = new FormData();
            initializeFormData.append('standards', standardsBlob, 'enonce.docx');
            const response = await fetch('/initialize', {
                method: 'POST',
                body: initializeFormData
            });
            if (response.ok) {
                const responseBody = await response.json();
                if (!responseBody.success)
                    throw new Error(responseBody.error || 'Une erreur est survenue lors de l\'initialisation.');
            } else
                throw new Error('Failed to initialize');

            const projectFiles = await fetch('');
            // J'abandonne
        } catch (error) {
            console.error('Error:', error);
        } */
    }

    function toggleMore() {
        const moreInfo = document.getElementById('more-info');
        const showMoreText = document.getElementById('show-more');
        const displayStyle = window.getComputedStyle(moreInfo).display;

        // If hidden, make the text appear
        if (displayStyle === 'none') {
            moreInfo.style.display = 'block';
            showMoreText.style.display = 'none';
        } else { // Otherwise, make it disappear
            moreInfo.style.display = 'none';
            showMoreText.style.display = 'inline';
        }
    }

    function nextClick() {
        const projectUpload = document.getElementById('student-documents');
        let projectUploadDisplay = window.getComputedStyle(projectUpload).display;

        // First box
        if (projectUploadDisplay === 'none') {
            if (document.getElementById('label-standards').innerHTML === 'Téléversez le fichier') {
                document.getElementById('label-standards').style.border = '1px solid red';
                document.getElementById('label-standards').style.color = 'red';
                document.getElementById('err-first-box').style.display = 'block';
                document.getElementById('err-first-box').textContent = 'Veuillez téléverser au moins l\'énoncé.';
                return;
            }
            // Switch to the next box
            projectUpload.style.display = 'flex';
            document.getElementById('teacher-documents').style.display = 'none';
        }
        // Second box
        else {
            // Check if the user uploaded the files in at least 1 input
            const studentFiles = document.getElementsByClassName('std-doc');
            let fileLoaded = false;
            for (let i = 0; i < studentFiles.length; i++) {
                if (studentFiles[i].innerHTML !== 'Téléversez les fichiers') {
                    fileLoaded = true;
                    break;
                }
            }
            // If no input has a file, display an error message
            if (!fileLoaded) {
                // Get label of first project
                document.querySelector('#label-project-1 .input-group').style.border = '1px solid red';
                document.querySelector('#label-project-1 .input-group').style.color = 'red';
                document.getElementById('err-scd-box').style.display = 'block';
                document.getElementById('err-scd-box').textContent = 'Veuillez téléverser au moins un fichier de projet.';
                return;
            }
            // Otherwise, switch to the next box
            projectUpload.style.display = 'none';
            document.getElementById('send-form').style.display = 'flex';
        }
    }

    function prevClick() {
        const teacherUpload = document.getElementById('teacher-documents');
        let teacherUploadDisplay = window.getComputedStyle(teacherUpload).display;

        if (teacherUploadDisplay === 'none') {
            teacherUpload.style.display = 'flex';
            document.getElementById('student-documents').style.display = 'none';
        }
    }

    function addProject() {
        // Get input count
        const inputCount = document.getElementsByClassName('std-project').length + 1;
        // Create new input box
        const newProject = document.createElement('div');
        newProject.id = 'label-project-'+inputCount;
        newProject.className = 'std-project';
        // Title
        const title = document.createElement('h3');
        title.textContent = `Projet #`+inputCount;
        newProject.appendChild(title);
        // Input group
        const inputGroup = document.createElement('div');
        inputGroup.className = 'input-group';
        // Label
        const label = document.createElement('label');
        label.htmlFor = 'file-project-'+inputCount;
        label.className = 'upload-box std-doc';
        label.textContent = 'Téléversez les fichiers';
        inputGroup.appendChild(label);
        // Input
        const input = document.createElement('input');
        input.id = 'file-project-'+inputCount;
        input.type = 'file';
        input.name = 'submissions';
        input.multiple = true;
        input.onchange = function() {
            updateFileLabel(this, 'label-project-'+inputCount);
        };
        inputGroup.appendChild(input);
        // Delete button
        const delButton = document.createElement('button');
        delButton.className = 'del-project';
        delButton.textContent = '-';
        delButton.onclick = function() {
            // Remove the project
            newProject.remove();
            // Get its id
            const id = newProject.id.split('-')[2];
            // Update the id of the following projects
            const projects = document.getElementsByClassName('std-project');
            for (let i = id-1; i < projects.length; i++) {
                projects[i].id = 'label-project-'+(i+1);
                projects[i].childNodes[0].textContent = `Projet #`+(i+1);
                projects[i].childNodes[1].childNodes[0].htmlFor = 'file-project-'+(i+1);
                projects[i].childNodes[1].childNodes[1].id = 'file-project-'+(i+1);
                projects[i].childNodes[1].childNodes[1].onchange = function() {
                    updateFileLabel(this, 'label-project-'+(i+1));
                };
            }
        };
        inputGroup.appendChild(delButton);
        // Insert before the add button
        newProject.appendChild(inputGroup);
        document.getElementById('add-project').insertAdjacentElement('beforebegin', newProject);
    }

    function updateFileLabel(input, labelId) {
        let label = document.getElementById(labelId);
        const files = input.files;

        let errDiv;
        if (labelId === 'label-standards' || labelId === 'label-criteria')
            errDiv = document.getElementById('err-first-box');
        else {
            errDiv = document.getElementById('err-scd-box');
            // Get the actual label
            label = label.querySelector('label');
        }

        // Check if the files are valid
        if (!validateFiles(files)) {
            label.style.border = '1px solid red';
            label.style.color = 'red';
            label.textContent = 'Téléversez les fichiers';
            errDiv.style.display = 'block';
            errDiv.textContent = `Les extensions acceptées sont .c, .cpp, .cs, .css, .doc, .docx, .go, 
            .html, .java, .js, .json, .md, .pdf, .php, .pptx, .py, .rb, .sh, .tex, .ts et .txt.`;
            return;
        }

        // Change the label with the file(s) name(s)
        if (files.length === 1)
            label.innerHTML = files[0].name;
        else if (files.length > 1) {
            let fileNames = Array.from(files).map(file => file.name).join(", ");
            // Replace text with files names
            label.innerHTML = fileNames;
        }

        label.style.border = '';
        label.style.color = '#000';
        errDiv.style.display = 'none';
    }

    function closeErrorTable() {
        document.getElementById('error-element').style.display = 'none';
    }

    function updateProgressBar() {
        const progressBar = document.getElementById('waiting-bar');
        const progressText = document.getElementById('waiting-text');

        // Receive updates from the /progress endpoint
        const progressSource = new EventSource('/progress');

        // Listen for messages
        progressSource.onmessage = (event) => {
            const data = JSON.parse(event.data);
            const progress = data.value;
            const message = data.message;

            // Update the progress bar
            if (progress)
                progressBar.value = progress;
            if (message)
                progressText.textContent = message;
            if (progress === 100) {
                progressSource.close();
            }
        };
    }

    function validateFiles(files) {
        const MAX_FILE_SIZE = 20 * 1024 * 1024; // 20 MB
        const validExtensions = ['c', 'cpp', 'cs', 'css', 'doc', 'docx', 'go', 'html', 'java', 'js',
            'json', 'md', 'pdf', 'php', 'pptx', 'py', 'rb', 'sh', 'tex', 'ts', 'txt'];
        let validFile;

        // Validate file size and extension
        for (let i = 0; i < files.length; i++) {
            const extension = files[i].name.split('.').pop().toLowerCase();
            if (files[i].size > MAX_FILE_SIZE || !validExtensions.includes(extension))
                return false;   // Invalid file
        }
        return true;
    }

    document.addEventListener('DOMContentLoaded', updateProgressBar);

    document.getElementById('send-form').addEventListener('submit', async (event) => {
        event.preventDefault(); // Prevent the form from submitting

        // Get standard and criteria files
        const standardsFile = document.getElementById('file-standards').files[0];
        const criteriaFile = document.getElementById('file-criteria').files[0];

        // Verify project count
        const projectInputs = document.getElementsByClassName('std-project');
        let nbFilesLoaded = 0;
        for (let i = 0; i < projectInputs.length; i++) {
            if (projectInputs[i].querySelector('label').innerHTML !== 'Téléversez les fichiers')
                nbFilesLoaded++;
        }

        // Do not send the form if no files were uploaded
        if (!standardsFile || !nbFilesLoaded)
            return;

        // Remove the box and show the waiting bar
        document.getElementById('student-documents').style.display = 'none';
        document.getElementById('waiting-ctn').style.display = 'flex';

        // Change waiting bar text
        document.getElementById('waiting-ctn').querySelector('p').textContent += nbFilesLoaded;

        try {
            const deleteFilesResponse = await fetch('/clean-up-tests', {
                method: 'POST'
            });

            // Prepare form data for initializing the assistant
            const initializeFormData = new FormData();
            initializeFormData.append('standards', standardsFile);
            if (criteriaFile)
                initializeFormData.append('criteria', criteriaFile);

            // Initialize the assistant
            const initializeResponse = await fetch('/initialize', {
                method: 'POST',
                body: initializeFormData
            });

            if (initializeResponse.ok) {
                const responseBody = await initializeResponse.json();
                if (!responseBody.success) {
                    throw new Error(responseBody.error || 'Une erreur est survenue lors de l\'initialisation.');
                }
            } else {
                throw new Error();
            }

            // Prepare form data for processing the student files
            const feedbackFormData = new FormData();
            for (let i = 0; i < projectInputs.length; i++) {
                const label = projectInputs[i].querySelector('label');
                if (label.innerHTML !== 'Téléversez les fichiers') {
                    const files = [...projectInputs[i].querySelector('input').files];
                    files.forEach((file) => feedbackFormData.append('submissions-'+i, file));
                }
            }

            // Query the API
            const feedbackResponse = await fetch('/ask', {
                method: 'POST',
                body: feedbackFormData
            });

            if (feedbackResponse.ok) {
                const responseBody = await feedbackResponse.json();
                if (!responseBody.success) {
                    throw new Error(responseBody.error || 'Une erreur est survenue lors de l\'initialisation.');
                }
            } else {
                throw new Error();
            }

            // Redirect to the next page
            window.location.href = 'response.html';
        } catch (error) {
            console.error('Error:', error);
            try {
                const deleteFilesResponse = await fetch('/clean-up-tests', {
                    method: 'POST'
                });
            } catch(error) {
                console.error('Error deleting tests:', error);
            }

            // Remove the waiting bar
            document.getElementById('waiting-ctn').style.display = 'none';

            // Display the error message
            document.getElementById('error-element').style.display = 'block';
            let errorMessage = 'Veuillez réessayer plus tard. Si le problème persiste, vous pouvez contacter amelie.lemay.1@ens.etsmtl.ca.';
            document.getElementById('sys-err-message').textContent = error.message + errorMessage;
        }
    });
</script>

</html>
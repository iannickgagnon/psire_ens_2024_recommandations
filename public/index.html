<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="title-container">
        <h1>Rétroaction par IA</h1>
    </div>
    <div class="description">
        <p>
            Bienvenue ! Ce site propose un outil de génération par intelligence artificielle de
            rétroaction pour les projets de programmation des étudiants, destiné à assister les
            enseignants dans leur évaluation.
        </p>
        <p>Pour débuter, téléverser vos fichiers plus bas.</p>
        <span class="show-hide-info" id="show-more" onclick="toggleMore()"><u>En savoir plus</u></span>
        <div id="more-info">
            <div class="red-line"></div>
            <p>
                Cet outil a été conçu pour assister les enseignants dans leur évaluation. Il s'agit
                d'un système capable de générer des retours sur les projets de programmation réalisés
                par les étudiants.
            </p>
            <p>
                En utilisant la bibliothèque OpenAI, qui alimente notamment ChatGPT,
                un agent LLM (modèle de langage) analyse le code des étudiants en le comparant aux
                documents fournis par l'enseignant, tels que l'énoncé du projet, et produit un rapport
                détaillé. <b>Cet outil ne vise pas à remplacer la correction humaine</b>, mais plutôt à
                soutenir les étudiants en mettant en lumière des éléments spécifiques du code que les
                enseignants n'ont pas toujours le temps d'examiner. Il revient à l'utilisateur de ce
                système de communiquer les commentaires générés aux étudiants.
            </p>
            <p>
                Pour utiliser cet outil, vous aurez besoin de l'énoncé du projet
                <span class="tooltip">(?)
                    <span class="tooltip-text">L'énoncé est le document expliquant aux étudiants ce
                        qu'ils doivent réaliser dans le projet</span>
                </span>.
                Vous pouvez ajouter un document de normes de programmation
                <span class="tooltip">(?)
                    <span class="tooltip-text">Ce document est général au cours et contient des
                        guides de bonne pratique en programmation comme le nom des variables,
                        l'indentation, etc.</span>
                </span> pour de meilleurs résultats par l'IA.
                Vous devez télécharger un projet à la fois ; une fois le traitement d'un projet
                terminé, vous serez invité à télécharger le suivant. Vous pourrez ensuite naviguer
                facilement d'une rétroaction à l'autre. Il y a une limite de 50 fichiers que vous
                pouvez télécharger par projet.
            </p>
            <p>Le temps de traitement peut varier en fonction du volume de documents déposés.
                En général, pour un projet relativement simple comportant une dizaine de
                fichiers, le traitement prend environ une minute.
            </p>
            <p>
                Les extensions de fichiers acceptées sont .c, .cpp, .cs, .css, .doc, .docx, .go, .html,
                .java, .js, .json, .md, .pdf, .php, .pptx, .py, .rb, .sh, .tex, .ts et .txt.
            </p>
            <p class="show-hide-info" id="show-less" onclick="toggleMore()"><u>Masquer</u></p>
        </div>
    </div>
    <div class="red-line"></div>
    <button id="shortcut" onclick="sendFilesShortcut()">Upload shortcut</button>
    <form id="send-form" enctype="multipart/form-data">
        <div id="teacher-documents" class="upload-container">
            <div>
                <h3>Énoncé</h3>
                <label id="label-standards" for="file-standards" class="upload-box">Téléversez le fichier</label>
                <input id="file-standards" type="file" name="standards"
                    onchange="updateFileLabel(this, 'label-standards')">
            </div>
            <div>
                <h3>Normes de programmation</h3>
                <label id="label-criteria" for="file-criteria" class="upload-box">Téléversez le fichier (optionnel mais
                    recommandé)</label>
                <input id="file-criteria" type="file" name="criteria"
                    onchange="updateFileLabel(this, 'label-criteria')">
            </div>
            <button class="next-button" onclick="nextClick()">Suivant</button>
            <p class="error-message" id="err-first-box"></p>
        </div>
        <div id="student-documents" class="upload-container">
            <div>
                <h3>Projet #1</h3>
                <label id="label-project" for="file-project" class="upload-box">Téléversez les fichiers</label>
                <input id="file-project" type="file" name="submissions" multiple
                    onchange="updateFileLabel(this, 'label-project')">
            </div>
            <div id="button-row">
                <button class="prev-button" onclick="prevClick()">Précédent</button>
                <button type="submit" class="next-button" onclick="nextClick()">Envoyer</button>
            </div>
            <p class="error-message" id="err-scd-box"></p>
        </div>
    </form>
    <div id="waiting-ctn">
        <label id="waiting-text" for="waiting-bar">Traitement en cours...</label>
        <progress id="waiting-bar" value="0" max="100"></progress>
    </div>
    <table id="error-element" cellspacing="0">
        <tr id="error-title">
            <td>Une erreur est survenue</td>
            <td id="close-error-btn" onclick="closeErrorTable()">X</td>
        </tr>
        <tr id="system-error">
            <td id="sys-err-message"></td>
        </tr>
    </table>
</body>

<script>
    // Shortcut for uploading files : to delete later
    async function sendFilesShortcut() {
        alert("WIP");
        /*
        try {
            const standardsFile = await fetch('/enonce.docx');
            if (!standardsFile)
                throw new Error('Error fetching standards file');
            const standardsBlob = await standardsFile.blob();
            const initializeFormData = new FormData();
            initializeFormData.append('standards', standardsBlob, 'enonce.docx');
            const response = await fetch('/initialize', {
                method: 'POST',
                body: initializeFormData
            });
            if (response.ok) {
                const responseBody = await response.json();
                if (!responseBody.success)
                    throw new Error(responseBody.error || 'Une erreur est survenue lors de l\'initialisation.');
            } else
                throw new Error('Failed to initialize');

            const projectFiles = await fetch('');
            // J'abandonne
        } catch (error) {
            console.error('Error:', error);
        } */
    }


    function toggleMore() {
        const moreInfo = document.getElementById('more-info');
        const showMoreText = document.getElementById('show-more');
        const displayStyle = window.getComputedStyle(moreInfo).display;

        // If hidden, make the text appear
        if (displayStyle === 'none') {
            moreInfo.style.display = 'block';
            showMoreText.style.display = 'none';
        } else { // Otherwise, make it disappear
            moreInfo.style.display = 'none';
            showMoreText.style.display = 'inline';
        }
    }

    function nextClick() {
        const projectUpload = document.getElementById('student-documents');
        let projectUploadDisplay = window.getComputedStyle(projectUpload).display;

        // First box
        if (projectUploadDisplay === 'none') {
            // Check if the user uploaded the files
            if (document.getElementById('label-standards').innerHTML === 'Téléversez le fichier') {
                document.getElementById('label-standards').style.border = '1px solid red';
                document.getElementById('label-standards').style.color = 'red';
                document.getElementById('err-first-box').style.display = 'block';
                document.getElementById('err-first-box').textContent = 'Veuillez téléverser au moins l\'énoncé.';
                return;
            }
            // Switch to the next box
            projectUpload.style.display = 'flex';
            document.getElementById('teacher-documents').style.display = 'none';
        }
        // Second box
        else {
            // Check if the user uploaded the files
            if (document.getElementById('label-project').innerHTML === 'Téléversez les fichiers') {
                document.getElementById('label-project').style.border = '1px solid red';
                document.getElementById('label-project').style.color = 'red';
                document.getElementById('err-scd-box').style.display = 'block';
                document.getElementById('err-scd-box').textContent = 'Veuillez téléverser au moins un fichier de projet.';
                return;
            }
            // Switch to the next box
            projectUpload.style.display = 'none';
            document.getElementById('send-form').style.display = 'flex';
        }
    }

    function prevClick() {
        const teacherUpload = document.getElementById('teacher-documents');
        let teacherUploadDisplay = window.getComputedStyle(teacherUpload).display;

        if (teacherUploadDisplay === 'none') {
            teacherUpload.style.display = 'flex';
            document.getElementById('student-documents').style.display = 'none';
        }
    }

    function updateFileLabel(input, labelId) {
        const label = document.getElementById(labelId);
        const files = input.files;

        let errDiv;
        if (label === 'label-standards')
            errDiv = document.getElementById('err-first-box');
        else
            errDiv = document.getElementById('err-scd-box');

        // Check if the files are valid
        if (!validateFiles(files)) {
            label.style.border = '1px solid red';
            label.style.color = 'red';
            errDiv.style.display = 'block';
            errDiv.textContent = `Les extensions acceptées sont .c, .cpp, .cs, .css, .doc, .docx, .go, 
            .html, .java, .js, .json, .md, .pdf, .php, .pptx, .py, .rb, .sh, .tex, .ts et .txt.`;
            return;
        }

        // Change the label with the file(s) name(s)
        if (files.length === 1)
            label.innerHTML = files[0].name;
        else if (files.length > 1) {
            let fileNames = Array.from(files).map(file => file.name).join(", ");
            // Replace text with files names
            label.innerHTML = fileNames;
        }

        label.style.border = '';
        label.style.color = '#000';
        errDiv.style.display = 'none';
    }

    function closeErrorTable() {
        document.getElementById('error-element').style.display = 'none';
    }

    function updateProgressBar() {
        const progressBar = document.getElementById('waiting-bar');
        const progressText = document.getElementById('waiting-text');

        // Receive updates from the /progress endpoint
        const progressSource = new EventSource('/progress');

        // Listen for messages
        progressSource.onmessage = (event) => {
            const data = JSON.parse(event.data);
            const progress = data.value;
            const message = data.message;

            // Update the progress bar
            if (progress)
                progressBar.value = progress;
            if (message)
                progressText.textContent = message;

            // If the progress is 100%, stop the progress bar
            if (progress === 100) {
                progressSource.close();
            }
        };
    }

    function validateFiles(files) {
        const MAX_FILE_SIZE = 20 * 1024 * 1024; // 20 MB
        const validExtensions = ['c', 'cpp', 'cs', 'css', 'doc', 'docx', 'go', 'html', 'java', 'js',
            'json', 'md', 'pdf', 'php', 'pptx', 'py', 'rb', 'sh', 'tex', 'ts', 'txt'];
        let validFile;

        // Validate file size and extension
        for (let i = 0; i < files.length; i++) {
            const extension = files[i].name.split('.').pop().toLowerCase();
            if (files[i].size > MAX_FILE_SIZE || !validExtensions.includes(extension))
                return false;   // Invalid file
        }
        return true;
    }

    document.addEventListener('DOMContentLoaded', updateProgressBar);

    document.getElementById('send-form').addEventListener('submit', async (event) => {
        event.preventDefault(); // Prevent the form from submitting

        // Get all files
        const standardsFile = document.getElementById('file-standards').files[0];
        const criteriaFile = document.getElementById('file-criteria').files[0];
        const projectFiles = [...document.getElementById('file-project').files];

        // Do not send the form if no files were uploaded
        if (!standardsFile || projectFiles.length === 0)
            return;

        // Remove the box and show the waiting bar
        document.getElementById('student-documents').style.display = 'none';
        document.getElementById('waiting-ctn').style.display = 'flex';

        try {
            const deleteFilesResponse = await fetch('/clean-up-tests', {
                method: 'POST'
            });

            // Prepare form data for initializing the assistant
            const initializeFormData = new FormData();
            initializeFormData.append('standards', standardsFile);
            if (criteriaFile)
                initializeFormData.append('criteria', criteriaFile);

            // Initialize the assistant
            const initializeResponse = await fetch('/initialize', {
                method: 'POST',
                body: initializeFormData
            });

            if (initializeResponse.ok) {
                const responseBody = await initializeResponse.json();
                if (!responseBody.success) {
                    throw new Error(responseBody.error || 'Une erreur est survenue lors de l\'initialisation.');
                }
            } else {
                throw new Error();
            }

            // Prepare form data for processing the first project
            const feedbackFormData = new FormData();
            projectFiles.forEach(file => feedbackFormData.append('submissions', file));

            // Query the API
            const feedbackResponse = await fetch('/ask', {
                method: 'POST',
                body: feedbackFormData
            });

            if (feedbackResponse.ok) {
                const responseBody = await feedbackResponse.json();
                if (!responseBody.success) {
                    throw new Error(responseBody.error || 'Une erreur est survenue lors de l\'initialisation.');
                }
            } else {
                throw new Error();
            }

            // Redirect to the next page
            window.location.href = 'response.html';
        } catch (error) {
            console.error('Error:', error);
            try {
                const deleteFilesResponse = await fetch('/clean-up-tests', {
                    method: 'POST'
                });
            } catch(error) {
                console.error('Error deleting tests:', error);
            }

            // Remove the waiting bar
            document.getElementById('waiting-ctn').style.display = 'none';

            // Display the error message
            document.getElementById('error-element').style.display = 'block';
            let errorMessage = 'Veuillez réessayer plus tard. Si le problème persiste, vous pouvez contacter amelie.lemay.1@ens.etsmtl.ca.';
            document.getElementById('sys-err-message').textContent = error.message + errorMessage;
        }
    });
</script>

</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="response.css">
</head>
<body>
    <div id="next-project">
        <p>Téléverser le prochain projet?</p>
        <div id="btn-row">
            <button id="next-project-button" onclick="nextProject()">Téléverser</button>
            <button id="end-button" onclick="finishDownload()">J'ai terminé</button>
        </div>
    </div>
    <div id="confirmation-box">
        <div id="confirmation-content">
            <p id="confirmation-text">Êtes-vous sûr.e d'avoir terminé?</p>
            <div id="confirmation-btn-row">
                <button id="confirm-button" onclick="confirmFinish()">Confirmer</button>
                <button id="cancel-button" onclick="cancelFinish()">Annuler</button>
            </div>
        </div>
    </div>
    <form id="send-form" enctype="multipart/form-data">
        <div id="label-project-1" class="std-project">
            <h3>Projet #</h3>
            <div class="input-group">
                <label for="file-project-1" class="upload-box std-doc">Téléversez les fichiers</label>
                <input id="file-project-1" type="file" name="submissions" multiple onchange="updateFileLabel(this, 'label-project-1')">
            </div>
        </div>
        <button type="button" id="add-project" onclick="addProject()">+<span class="tooltip-text">Ajouter un autre projet</span></button>
        <div id="button-row">
            <button type="button" onclick="cancelLoad()">Annuler</button>
            <button type="submit">Envoyer</button>
        </div>
        <p id="error-message"></p>
    </form>
    <div id="waiting-ctn">
        <p>1 de 1</p>
        <label id="waiting-text" for="waiting-bar">Traitement en cours...</label>
        <progress id="waiting-bar" value="0" max="100"></progress>
    </div>
    <table id="error-element" cellspacing="0">
        <tr id="error-title">
            <td>Une erreur est survenue</td>
            <td id="close-error-btn" onclick="closeErrorTable()">X</td>
        </tr>
        <tr id="system-error">
            <td id="sys-err-message"></td>
        </tr>
    </table>
    <div id="response-container">
        <div id="menu">
            <div class="menu-item selected" id="pj-0" onclick="displayProject(0)">Projet 1</div>
        </div>
        <div id="response">
            <div id="bullet-points">
                <div id="strengths-column" class="response-column">
                    <h2>Forces</h2>
                </div>
                <div id="weaknesses-column" class="response-column">
                    <h2>Faiblesses</h2>
                </div>
            </div>
            <div id="summary">
                <h2>Résumé</h2>
            </div>
        </div>
    </div>
</body>

<script>
    let currentProject = 0;
    const responseTexts = [];
    const selectedResponse = [];
    let userFinished = false;
    let summaries = [];

    // Prepare the progress bar
    document.addEventListener('DOMContentLoaded', SSENotification);

    // Store the variables before the page is closed
    window.onbeforeunload = async function() {
        // Store checked responses
        try {
            const response = await fetch('/store-checked-responses', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({checkedResponses: selectedResponse})
            });
        } catch (error) {
            console.log(error);
            console.log('Could not store checked responses.');
        }

        sessionStorage.setItem('projectCount', currentProject);
        sessionStorage.setItem('userFinished', userFinished);
        sessionStorage.setItem('currentProject', document.getElementsByClassName('selected')[0].id.split('-')[1]);
    }

    // Recreate the closed tabs on refresh
    window.onload = async function() {
        // Get stored API responses
        try {
            // Fetch the response page
            const response = await fetch('/get-stored-responses');
            const data = await response.json();

            if (data.success && data.allResponses) {
                // Store the API responses
                for (let i = 0; i < data.allResponses.length; i++)
                    storeResponse(data.allResponses[i], i);
                // Check if selected responses are available and store them
                if (!data.checkedResponses) {
                    // Tell the user that the responses were lost
                    document.getElementById('error-element').style.display = 'block';
                    document.getElementById('sys-err-message').textContent = 
                    'Vos réponses sélectionnées n\'ont malheureusement pas été sauvegardées.';
                } else {
                    // Store the checked responses
                    for (let i = 0; i < data.checkedResponses.length; i++)
                        selectedResponse[i] = data.checkedResponses[i];
                }
                // Check if the summaries are available and store them
                if (data.summaries)
                    // Split the summaries by project
                    summaries = (data.summaries.split('/').filter(Boolean)).map(summary => summary.trim());
                else if (userFinished) {
                    // Indicate to the user that the summaries were lost
                    document.getElementById('error-element').style.display = 'block';
                    document.getElementById('sys-err-message').textContent = 'Les résumés ont malheureusement été perdues.';
                }
            } else {
                // Indicate to the user that the response is not yet available
                document.getElementById('error-element').style.display = 'block';
                document.getElementById('sys-err-message').textContent = 'Les réponses ont malheureusement été perdues.';
            }
        } catch (error) {
            console.log(error);
            // Display the error message
            document.getElementById('error-element').style.display = 'block';
            document.getElementById('sys-err-message').textContent = `Les réponses ont malheureusement été perdues.`;
        }

        // Restore global variables
        currentProject = parseInt(sessionStorage.getItem('projectCount')) || 0;
        userFinished = sessionStorage.getItem('userFinished') === 'true';
        const currentId = sessionStorage.getItem('currentProject') || 0;

        // Recreate all tabs
        for (let i = 1; i <= currentProject; i++) {
            const menuItem = document.createElement('div');
            menuItem.className = 'menu-item';
            menuItem.id = `pj-${i}`;
            menuItem.textContent = `Projet ${i + 1}`;
            menuItem.onclick = () => displayProject(i);
            document.getElementById('menu').appendChild(menuItem);
        }

        // If user was finished, do not show download box
        if (userFinished) {
            cancelFinish();
            document.getElementById('next-project').style.display = 'none';
            document.getElementById('summary').style.display = 'block';
            document.getElementById('bullet-points').borderBottom = '2px solid #de022b';
        }

        // Display the current project
        displayProject(currentId);
    }

    function nextProject() {
        // Hide header box
        document.getElementById('next-project').style.display = 'none';

        // Show download box
        document.getElementById('send-form').style.display = 'flex';

        // Change title
        document.getElementById('label-project-1').querySelector('h3').textContent = "Projet #" + (currentProject + 2);
    }

    function finishDownload() {
        // Show confirmation box
        document.getElementById('confirmation-box').style.display = 'flex';
    }

    function cancelFinish() {
        // Hides confirmation box
        document.getElementById('confirmation-box').style.display = 'none';
    }

    async function confirmFinish() {
        // Hides confirmation box and header box
        cancelFinish();
        document.getElementById('next-project').style.display = 'none';

        // Get the response summaries
        try {
            const response = await fetch('/get-summaries', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ checkedResponses: selectedResponse })
            });
            const data = await response.json();

            if (data.success && data.response) {
                userFinished = true;
                document.getElementById('summary').style.display = 'block';
                document.getElementById('bullet-points').borderBottom = '2px solid #de022b';

                // Split the summaries by project
                summaries = (data.response.split('/').filter(Boolean)).map(summary => summary.trim());

                // Display summary of current project
                const currentId = document.getElementsByClassName('selected')[0].id.split('-')[1];
                displayProject(currentId);
            } else {
                // Indicate to the user that the response is not yet available
                document.getElementById('error-element').style.display = 'block';
                document.getElementById('sys-err-message').textContent = 'La réponse n\'est pas encore disponible.';
            }
        } catch (error) {
            console.error(error);
            // Display the error message
            document.getElementById('error-element').style.display = 'block';
            document.getElementById('sys-err-message').textContent = `La réponse n'a pas pu être obtenue 
            du serveur. Veuillez réessayer plus tard. Si le problème persiste, vous pouvez contacter 
            amelie.lemay.1@ens.etsmtl.ca.`;
        }

        // Do smth (like download file)
    }

    function cancelLoad() {
        // Hide download box
        document.getElementById('send-form').style.display = 'none';

        // Show header box
        document.getElementById('next-project').style.display = 'flex';
    }

    function closeErrorTable() {
        document.getElementById('error-element').style.display = 'none';
    }

    function addProject() {
        // Get input count
        const inputCount = document.getElementsByClassName('std-project').length + 1;
        // Create new input box
        const newProject = document.createElement('div');
        newProject.id = 'label-project-' + inputCount;
        newProject.className = 'std-project';
        // Title
        const prevNumber = parseInt(document.getElementsByClassName('std-project')[inputCount-2].querySelector('h3').textContent.split('#')[1]);
        const title = document.createElement('h3');
        title.textContent = `Projet #` + (prevNumber + 1);
        newProject.appendChild(title);
        // Input group
        const inputGroup = document.createElement('div');
        inputGroup.className = 'input-group';
        // Label
        const label = document.createElement('label');
        label.htmlFor = 'file-project-' + inputCount;
        label.className = 'upload-box std-doc';
        label.textContent = 'Téléversez les fichiers';
        inputGroup.appendChild(label);
        // Input
        const input = document.createElement('input');
        input.id = 'file-project-' + inputCount;
        input.type = 'file';
        input.name = 'submissions';
        input.multiple = true;
        input.onchange = function () {
            updateFileLabel(this, 'label-project-' + inputCount);
        };
        inputGroup.appendChild(input);
        // Delete button
        const delButton = document.createElement('button');
        delButton.className = 'del-project';
        delButton.textContent = '-';
        delButton.onclick = function () {
            // Remove the project
            newProject.remove();
            // Get its id
            const id = newProject.id.split('-')[2];
            // Get its project count
            let projectCount = title.textContent.split('#')[1];
            // Update the id of the following projects
            const projects = document.getElementsByClassName('std-project');
            for (let i = id - 1; i < projects.length; i++, projectCount++) {
                projects[i].id = 'label-project-' + (i + 1);
                projects[i].childNodes[0].textContent = `Projet #` + (projectCount);
                projects[i].childNodes[1].childNodes[0].htmlFor = 'file-project-' + (i + 1);
                projects[i].childNodes[1].childNodes[1].id = 'file-project-' + (i + 1);
                projects[i].childNodes[1].childNodes[1].onchange = function () {
                    updateFileLabel(this, 'label-project-' + (i + 1));
                };
            }
        };
        inputGroup.appendChild(delButton);
        // Insert before the add button
        newProject.appendChild(inputGroup);
        document.getElementById('add-project').insertAdjacentElement('beforebegin', newProject);
    }

    function updateFileLabel(input, labelId) {
        const label = document.getElementById(labelId).querySelector('label');
        const files = input.files;
        const errDiv = document.getElementById('error-message');
        const MAX_FILE_SIZE = 20 * 1024 * 1024; // 20 MB
        const validExtensions = ['c', 'cpp', 'cs', 'css', 'doc', 'docx', 'go', 'html', 'java', 'js',
            'json', 'md', 'pdf', 'php', 'pptx', 'py', 'rb', 'sh', 'tex', 'ts', 'txt'];
        let validFile = true;

        // Validate file size and extension
        for (let i = 0; i < files.length; i++) {
            const extension = files[i].name.split('.').pop().toLowerCase();
            if (files[i].size > MAX_FILE_SIZE || !validExtensions.includes(extension))
                validFile = false;   // Invalid file
        }

        if (!validFile) {
            label.style.border = '1px solid red';
            label.style.color = 'red';
            label.textContent = 'Téléversez les fichiers';
            errDiv.style.display = 'block';
            errDiv.textContent = `Les extensions acceptées sont .c, .cpp, .cs, .css, .doc, .docx, .go, 
            .html, .java, .js, .json, .md, .pdf, .php, .pptx, .py, .rb, .sh, .tex, .ts et .txt.`;
            return;
        }

        // Change the label with the file(s) name(s)
        if (files.length === 1)
            label.innerHTML = files[0].name;
        else if (files.length > 1) {
            let fileNames = Array.from(files).map(file => file.name).join(", ");
            // Replace text with files names
            label.innerHTML = fileNames;
        }

        label.style.border = '';
        label.style.color = '#000';
        errDiv.style.display = 'none';
    }

    function displayProject(id) {
        // Revert previous selected item style
        const prevMenuItem = document.getElementsByClassName('selected')[0];
        if (prevMenuItem)
            prevMenuItem.classList.remove('selected');

        // Get the element and change its style
        const element = document.getElementById("pj-" + id);
        element.classList.add('selected');

        // Clear the columns
        const strengthsColumn = document.getElementById('strengths-column');
        const weaknessesColumn = document.getElementById('weaknesses-column');
        const summaryBox = document.getElementById('summary');
        strengthsColumn.innerHTML = '<h2>Forces</h2>';
        weaknessesColumn.innerHTML = '<h2>Faiblesses</h2>';
        summaryBox.innerHTML = '<h2>Résumé</h2>';

        // If user is not finished, display all boxes
        if (!userFinished) {
            // Add the strengths to the column
            responseTexts[id].strengths.forEach(line => {
                // Create the html element and add to the column
                const newDiv = createChecklistItem(line, id);
                strengthsColumn.appendChild(newDiv);
            });
            // Add the weaknesses to the column
            responseTexts[id].weaknesses.forEach(line => {
                // Create the html element and add to the column
                const newDiv = createChecklistItem(line, id);
                weaknessesColumn.appendChild(newDiv);
            });
        }
        // If user is finished, display selected boxes and summary
        else {
            // Add selected strengths to the column
            selectedResponse[id].strengths.forEach(line => {
                // Create a <p> element and add to the column
                const newLine = document.createElement('p');
                newLine.textContent = line;
                strengthsColumn.appendChild(newLine);
            });
            // Add selected weaknesses to the column
            selectedResponse[id].weaknesses.forEach(line => {
                // Create a <p> element and add to the column
                const newLine = document.createElement('p');
                newLine.textContent = line;
                weaknessesColumn.appendChild(newLine);
            });

            // Append the summary
            const summary = document.createElement('p');
            summary.textContent = summaries[id];
            summaryBox.appendChild(summary);
        }

        // Adjust the menu's height depending on the response's
        const menu = document.getElementById('menu');
        const responseHeight = (strengthsColumn.offsetHeight > weaknessesColumn.offsetHeight ?
            strengthsColumn.offsetHeight : weaknessesColumn.offsetHeight)
            + summaryBox.offsetHeight;
        menu.style.height = responseHeight + 'px';
    }

    function checkboxClicked(event) {
        // Get the checkbox
        const checkbox = event.target;
        // Get the parent div
        const parentDiv = checkbox.parentElement;
        // Get the project id
        const id = parseInt(parentDiv.classList[1].split('-')[1]);
        // Get the text
        const text = parentDiv.children[1].textContent;
        // Get the column
        const column = parentDiv.parentElement.id;
        // Get the checkbox state
        const checked = checkbox.checked;

        // Add the text to the selected responses
        if (checked) {
            if (column === 'strengths-column')
                selectedResponse[id].strengths.push(text);
            else
                selectedResponse[id].weaknesses.push(text);
        }
        // Remove the text from the selected responses
        else {
            if (column === 'strengths-column') {
                const index = selectedResponse[id].strengths.indexOf(text);
                if (index !== -1)
                    selectedResponse[id].strengths.splice(index, 1);
            } else {
                const index = selectedResponse[id].weaknesses.indexOf(text);
                if (index !== -1)
                    selectedResponse[id].weaknesses.splice(index, 1);
            }
        }
    }

    function storeResponse(response, index) {
        // Split the response by lines and remove empty lines
        const lines = response.split('Faiblesses:');
        const strengths = lines[0].split('Forces:')[1].split('\n').filter(line => line.trim() !== '');
        const weaknesses = lines[1].split('\n').filter(line => line.trim() !== '');

        // Remove "- " from the beginning of each line
        for (let i = 0; i < strengths.length; i++)
            strengths[i] = strengths[i].slice(2);
        for (let i = 0; i < weaknesses.length; i++)
            weaknesses[i] = weaknesses[i].slice(2);

        // Store the response
        responseTexts[index] = {
            strengths: strengths,
            weaknesses: weaknesses
        };

        // Initialize selected response array
        selectedResponse[index] = {
            strengths: [],
            weaknesses: []
        };
    }

    function createChecklistItem(line, id) {
        const newDiv = document.createElement('div');
        newDiv.classList.add('response-item');
        newDiv.classList.add('pj-' + id);
        // Add the checkbox
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.addEventListener('click', checkboxClicked);
        // If it is selected, check the box
        if (selectedResponse[id] && (selectedResponse[id].strengths.includes(line) || 
            selectedResponse[id].weaknesses.includes(line)))
            checkbox.checked = true;
        // Add the text
        const text = document.createElement('span');
        text.textContent = line;
        newDiv.appendChild(checkbox);
        newDiv.appendChild(text);
        return newDiv;
    }

    function SSENotification() {
        const progressBar = document.getElementById('waiting-bar');
        const progressCtn = document.getElementById('waiting-ctn');
        const progressText = document.getElementById('waiting-text');

        // Receive updates from the /progress endpoint
        const progressSource = new EventSource('/progress');

        // Listen for messages
        progressSource.onmessage = (event) => {
            const data = JSON.parse(event.data);

            // Update the progress bar
            if (data.value) {
                // Show waiting bar
                progressCtn.style.display = 'flex';
                progressBar.value = data.value;
                if (data.message) {
                    progressText.textContent = data.message;
                    if (data.currentGroup && data.nbGroups)
                        progressCtn.querySelector('p').textContent = data.currentGroup + ' de ' + data.nbGroups;
                }
                
                // If the progress is 100%, hide the bar
                if (data.value === 100)
                    progressCtn.style.display = 'none';
            }

            // New feedback received
            else if (data.projectNumber)
                // Fetch and store the response
                fetchResponse();
        };

        // Close the connection when the teacher is done
        document.getElementById('confirm-button').addEventListener('click', () => {
            progressSource.close();
        });

    }

    async function fetchResponse() {
        // Increment project count
        currentProject++;

        try {
            // Fetch the response page
            const response = await fetch('/get-api-response', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ pjNumber: currentProject })
            });
            const data = await response.json();

            if (data.success && data.response) {
                // Store the response
                storeResponse(data.response, currentProject);
                // Show new menu item
                const menuItem = document.createElement('div');
                menuItem.className = 'menu-item';
                menuItem.id = `pj-${currentProject}`;
                menuItem.textContent = `Projet ${currentProject + 1}`;
                menuItem.onclick = () => displayProject(menuItem.id.split('-')[1]);
                document.getElementById('menu').appendChild(menuItem);
            } else {
                // Indicate to the user that the response is not yet available
                document.getElementById('error-element').style.display = 'block';
                document.getElementById('sys-err-message').textContent = 'La réponse n\'est pas encore disponible.';
            }
        } catch (error) {
            console.error(error);
            // Display the error message
            document.getElementById('error-element').style.display = 'block';
            document.getElementById('sys-err-message').textContent = `La réponse n'a pas pu être obtenue 
            du serveur. Veuillez réessayer plus tard. Si le problème persiste, vous pouvez contacter 
            amelie.lemay.1@ens.etsmtl.ca.`;
        }
    }

    document.getElementById('send-form').addEventListener('submit', async (event) => {
        event.preventDefault(); // Prevent the form from submitting

        // Check if the user uploaded the files in at least 1 input
        const projectInputs = document.getElementsByClassName('std-project');
        let hasValidFile = false;
        for (let i = 0; i < projectInputs.length; i++) {
            if (projectInputs[i].querySelector('label').innerHTML !== 'Téléversez les fichiers') {
                hasValidFile = true;
                break;
            }
        }
        
        // If no files were uploaded, display an error message and do not submit
        if (!hasValidFile) {
            // Get label of first project
            document.querySelector('#label-project-1 .input-group').style.border = '1px solid red';
            document.querySelector('#label-project-1 .input-group').style.color = 'red';
            document.getElementById('error-message').style.display = 'block';
            document.getElementById('error-message').textContent = 'Veuillez téléverser au moins un fichier de projet.';
            return;
        }

        // Show header box again
        cancelLoad();

        try {
            // Prepare form data
            const formData = new FormData();
            for (let i = 0; i < projectInputs.length; i++) {
                const label = projectInputs[i].querySelector('label');
                if (label.innerHTML !== 'Téléversez les fichiers') {
                    const files = [...projectInputs[i].querySelector('input').files];
                    files.forEach((file) => formData.append('submissions-' + i, file));
                }
            }

            // Generate feedback for current project
            const response = await fetch('/ask', {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                const responseBody = await response.json();
                if (!responseBody.success) {
                    throw new Error(responseBody.error || 'Une erreur est survenue lors de l\'initialisation.');
                }
            } else {
                throw new Error();
            }

            // Get the response
            await fetchResponse(currentProject);
        } catch (error) {
            // Remove the waiting bar
            document.getElementById('waiting-ctn').style.display = 'none';

            // Display the error message
            document.getElementById('error-element').style.display = 'block';
            let errorMessage = 'Veuillez réessayer plus tard. Si le problème persiste, vous pouvez contacter amelie.lemay.1@ens.etsmtl.ca.';
            document.getElementById('sys-err-message').textContent = error.message + errorMessage;
        }
    });
</script>

</html>